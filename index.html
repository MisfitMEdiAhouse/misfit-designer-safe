<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Misfit Designer</title>
  <style>
    :root{--bg:#0b0b0b;--card:#141414;--line:#232323;--text:#f2f2f2;--muted:#9aa0a6}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial}
    .wrap{max-width:1100px;margin:0 auto;padding:18px}
    h1{margin:8px 0 16px;font-size:22px}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:18px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:16px}
    label{display:block;font-size:13px;color:var(--muted);margin:12px 0 6px}
    input[type="file"],input[type="text"],input[type="email"],textarea,select,button{
      width:100%;padding:10px 12px;border-radius:10px;border:1px solid var(--line);background:#0f0f0f;color:var(--text)
    }
    textarea{min-height:72px;resize:vertical}
    button{cursor:pointer}
    .row{display:flex;gap:10px}
    .row>*{flex:1}
    canvas{width:100%;max-height:68vh;background:#0a0a0a;border:1px dashed #2b2b2b;border-radius:12px}
    .hint{font-size:12px;color:var(--muted);margin:6px 0}
    .actions{display:flex;gap:10px;margin-top:12px}
    .actions button{flex:1}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Misfit Designer</h1>
    <div class="grid">
      <div class="card">
        <label>Upload image (PNG/JPG)</label>
        <input id="file" type="file" accept="image/png,image/jpeg" />

        <label>Or generate with AI (prompt)</label>
        <textarea id="prompt" placeholder="cyberpunk skull with neon roses, sticker style, high detail"></textarea>
        <div class="actions" style="margin-top:8px">
          <button id="gen">Generate Image</button>
        </div>
        <p id="genStatus" class="hint"></p>

        <label>Add text</label>
        <input id="text" type="text" placeholder="Type something…" />

        <div class="row">
          <div>
            <label>Font</label>
            <select id="font">
              <option value="Inter">Inter</option>
              <option value="Arial">Arial</option>
              <option value="Impact">Impact</option>
              <option value="Times New Roman">Times New Roman</option>
            </select>
          </div>
          <div>
            <label>Size</label>
            <select id="size">
              <option>48</option>
              <option selected>72</option>
              <option>96</option>
              <option>128</option>
            </select>
          </div>
        </div>

        <label>Your Email (optional copy)</label>
        <input id="email" type="email" placeholder="you@example.com" />

        <label>Shop Email</label>
        <input id="shopEmail" type="email" placeholder="printshop@example.com" />
        <p class="hint">Proofs go to this address with PNG + SVG attachments.</p>

        <div class="actions">
          <button id="send">Send to Print Shop</button>
          <button id="dlPng">Download PNG</button>
          <button id="dlSvg">Download SVG</button>
        </div>
        <p id="status" class="hint"></p>
      </div>

      <div class="card">
        <canvas id="c" width="1600" height="1600" aria-label="Design canvas"></canvas>
      </div>
    </div>
  </div>

<script>
const c = document.getElementById('c');
const ctx = c.getContext('2d', { willReadFrequently:false });
let img = null;
const state = { text:'', font:'Inter', size:72 };

function draw(){
  ctx.fillStyle = '#111'; ctx.fillRect(0,0,c.width,c.height);

  if(img){
    const maxSide = 1500;
    const scale = Math.min(maxSide/img.width, maxSide/img.height, 1);
    const w = Math.floor(img.width*scale);
    const h = Math.floor(img.height*scale);
    const x = Math.floor((c.width - w)/2);
    const y = Math.floor((c.height - h)/2);
    ctx.drawImage(img, x, y, w, h);
  }

  if(state.text){
    ctx.font = `${state.size}px ${state.font}`;
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    ctx.shadowColor = 'rgba(255,255,255,0.35)';
    ctx.shadowBlur = 10;
    ctx.fillStyle = '#fff';
    ctx.fillText(state.text, c.width/2, c.height*0.85);
    ctx.shadowBlur = 0;
  }

  ctx.strokeStyle = 'rgba(255,255,255,0.12)';
  ctx.lineWidth = 1;
  ctx.beginPath();
  ctx.moveTo(c.width/2,0); ctx.lineTo(c.width/2,c.height);
  ctx.moveTo(0,c.height/2); ctx.lineTo(c.width,c.height/2);
  ctx.stroke();
}
draw();

function setImageFromUrl(url){
  const newImg = new Image();
  newImg.crossOrigin = 'anonymous';
  newImg.onload = ()=>{ img = newImg; draw(); };
  newImg.src = url;
}

document.getElementById('file').addEventListener('change', e=>{
  const f = e.target.files[0]; if(!f) return;
  if(f.size > 12*1024*1024){ alert('Image too large (>12MB).'); return; }
  const reader = new FileReader();
  reader.onload = ev=> setImageFromUrl(ev.target.result);
  reader.readAsDataURL(f);
});
document.getElementById('text').addEventListener('input', e=>{ state.text = e.target.value.slice(0,140); draw(); });
document.getElementById('font').addEventListener('change', e=>{ state.font = e.target.value; draw(); });
document.getElementById('size').addEventListener('change', e=>{ state.size = parseInt(e.target.value,10)||72; draw(); });

function pngDataUrl(){ return c.toDataURL('image/png'); }
function svgText(){
  const png = pngDataUrl();
  return `<svg xmlns='http://www.w3.org/2000/svg' width='${c.width}' height='${c.height}'>
    <image href='${png}' x='0' y='0' width='${c.width}' height='${c.height}'/>
  </svg>`;
}
function download(filename, content, type='application/octet-stream'){
  const blob = new Blob([content], { type });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = filename;
  document.body.appendChild(a); a.click(); a.remove();
  setTimeout(()=>URL.revokeObjectURL(a.href), 1000);
}
document.getElementById('dlPng').addEventListener('click', ()=>{
  const b64 = atob(pngDataUrl().split(',')[1]);
  const buf = new Uint8Array(b64.length);
  for(let i=0;i<b64.length;i++) buf[i] = b64.charCodeAt(i);
  download('design.png', buf, 'image/png');
});
document.getElementById('dlSvg').addEventListener('click', ()=>{
  const svg = svgText();
  download('design.svg', svg, 'image/svg+xml');
});

// === AI Generate ===
document.getElementById('gen').addEventListener('click', async ()=>{
  const genStatus = document.getElementById('genStatus');
  const prompt = (document.getElementById('prompt')?.value || '').trim();
  if(!prompt){ genStatus.textContent = 'Enter a prompt first.'; return; }
  genStatus.textContent = 'Generating…';

  try{
    const res = await fetch('/api/generate-image', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ prompt, size: '1024x1024' })
    });
    const j = await res.json();
    if(!j.ok){ genStatus.textContent = 'Error: ' + (j.error || 'Unknown'); return; }

    // Use returned URL
    setImageFromUrl(j.url);
    genStatus.textContent = 'Done.';
  }catch(err){
    genStatus.textContent = 'Network error.';
  }
});

// === Send to Print ===
async function send(){
  const status = document.getElementById('status');
  status.textContent = 'Preparing…';

  const png = pngDataUrl();
  const b64 = png.split(',')[1];
  const svg = svgText();
  const svgB64 = btoa(unescape(encodeURIComponent(svg)));

  const toEmail = (document.getElementById('email')?.value || '').trim();
  const shopEmail = (document.getElementById('shopEmail')?.value || '').trim();

  const payload = {
    toEmail,
    shopEmail,
    meta: { app:'misfit', ts: new Date().toISOString() },
    attachments: [
      { filename:'design.png', content:b64, contentType:'image/png' },
      { filename:'design.svg', content:svgB64, contentType:'image/svg+xml' }
    ]
  };

  try{
    const res = await fetch('/api/send-to-print', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify(payload)
    });
    const j = await res.json();
    status.textContent = j.ok ? 'Sent! Check inbox(es).' : ('Error: ' + (j.error || 'Unknown'));
  }catch(err){
    status.textContent = 'Network error.';
  }
}
document.getElementById('send').addEventListener('click', send);
</script>
</body>
</html>
